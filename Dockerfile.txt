# ==========================================
# Stage 1: Builder
# ==========================================
FROM node:22-alpine AS builder

# Set working directory
WORKDIR /app

# Update npm to latest
RUN npm install -g npm@latest

# Install dependencies
COPY package.json ./
RUN npm install

# Copy source code
COPY . .

# Build the frontend
RUN npm run build

# ==========================================
# Stage 2: Production Runner
# ==========================================
FROM node:22-alpine AS runner

WORKDIR /app

# Set production environment
ENV NODE_ENV=production
ENV PORT=3000

# Install Nginx and latest npm
# Create necessary directories for Nginx
RUN apk add --no-cache nginx && \
    npm install -g npm@latest && \
    mkdir -p /var/log/nginx /var/run /etc/nginx && \
    rm -rf /var/cache/apk/*

# Copy package.json
COPY package.json ./

# Copy tsconfig.json (required for tsx)
COPY tsconfig.json ./

# Install production dependencies
RUN npm install --omit=dev && \
    npm cache clean --force

# Copy built assets
COPY --from=builder /app/dist ./dist

# Copy server code
COPY server.ts ./

# Copy Nginx configuration
COPY nginx.txt /etc/nginx/nginx.conf

# Verify Nginx configuration
RUN nginx -t

# Create startup script to run both Nginx and Node
# We start Nginx in the background (default behavior) and then run the Node app
RUN echo "#!/bin/sh" > start.sh && \
    echo "export NODE_ENV=production" >> start.sh && \
    echo "echo 'Starting Nginx...'" >> start.sh && \
    echo "nginx" >> start.sh && \
    echo "echo 'Starting Node.js server...'" >> start.sh && \
    echo "npm start" >> start.sh && \
    chmod +x start.sh

# Expose ports (Nginx on 80, Node on 3000)
EXPOSE 80 3000

# Start the application
CMD ["./start.sh"]
