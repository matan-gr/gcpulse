# ==========================================
# Stage 1: Builder
# ==========================================
FROM node:22-alpine AS builder

# Set working directory
WORKDIR /app

# Install dependencies
COPY package.json ./
RUN npm install

# Copy source code
COPY . .

# Build the frontend
RUN npm run build

# ==========================================
# Stage 2: Production Runner
# ==========================================
FROM node:22-alpine AS runner

WORKDIR /app

# Set production environment
ENV NODE_ENV=production
ENV PORT=3000

# Install Nginx and latest npm
RUN apk add --no-cache nginx && \
    npm install -g npm@latest

# Copy package.json
COPY package.json ./

# Install production dependencies
RUN npm install --omit=dev

# Copy built assets
COPY --from=builder /app/dist ./dist

# Copy server code
COPY server.ts ./

# Copy Nginx configuration
COPY nginx.txt /etc/nginx/nginx.conf

# Create startup script to run both Nginx and Node
RUN echo "#!/bin/sh" > start.sh && \
    echo "nginx" >> start.sh && \
    echo "npm start" >> start.sh && \
    chmod +x start.sh

# Expose ports (Nginx on 80, Node on 3000)
EXPOSE 80 3000

# Start the application
CMD ["./start.sh"]
