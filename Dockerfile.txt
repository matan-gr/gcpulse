# ==========================================
# Stage 1: Builder
# ==========================================
FROM node:22-alpine AS builder

# Set working directory
WORKDIR /app

# Update npm to latest
RUN npm install -g npm@latest

# Install dependencies
COPY package.json ./
RUN npm install

# Copy source code
COPY . .

# Build the frontend
RUN npm run build

# ==========================================
# Stage 2: Production Runner
# ==========================================
FROM node:22-alpine AS runner

WORKDIR /app

# Set production environment
ENV NODE_ENV=production
# Note: We do NOT set PORT here to avoid conflict with Cloud Run's injected PORT.
# Node listens on 3000 internally. Nginx listens on $PORT (default 8080).

# Install Nginx and latest npm
# Create necessary directories for Nginx
RUN apk add --no-cache nginx && \
    npm install -g npm@latest && \
    mkdir -p /var/log/nginx /var/run /etc/nginx && \
    rm -rf /var/cache/apk/*

# Copy package.json
COPY package.json ./

# Copy tsconfig.json (required for tsx)
COPY tsconfig.json ./

# Install production dependencies
RUN npm install --omit=dev && \
    npm cache clean --force

# Copy built assets
COPY --from=builder /app/dist ./dist

# Copy server code
COPY server.ts ./

# Copy Nginx configuration
COPY nginx.txt /etc/nginx/nginx.conf

# Verify Nginx configuration
RUN nginx -t

# Create startup script to run both Nginx and Node
# We start Node in the background and wait for it to be ready before starting Nginx
RUN echo "#!/bin/sh" > start.sh && \
    echo "export NODE_ENV=production" >> start.sh && \
    echo "# Replace 8080 in nginx.conf with the actual PORT env var (default 8080)" >> start.sh && \
    echo "sed -i \"s/8080/\${PORT:-8080}/g\" /etc/nginx/nginx.conf" >> start.sh && \
    echo "echo 'Starting Node.js server...'" >> start.sh && \
    echo "npm start &" >> start.sh && \
    echo "NODE_PID=\$!" >> start.sh && \
    echo "# Wait for Node to be ready" >> start.sh && \
    echo "echo 'Waiting for Node.js to start on port 3000...'" >> start.sh && \
    echo "until nc -z 127.0.0.1 3000; do" >> start.sh && \
    echo "  sleep 0.5" >> start.sh && \
    echo "done" >> start.sh && \
    echo "echo 'Node.js is up! Starting Nginx on port \${PORT:-8080}...'" >> start.sh && \
    echo "nginx -g 'daemon off;'" >> start.sh && \
    chmod +x start.sh

# Expose port 8080 (documentation only)
EXPOSE 8080

# Start the application
CMD ["./start.sh"]
